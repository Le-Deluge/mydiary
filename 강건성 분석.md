* 패널 로짓 모형 분석 =========================================== 

// 0. 모든 메모리 삭제 및 출력 멈춤 해제
clear all
set more off

// 1. 작업 폴더 설정 (경로는 필요에 따라 수정)
cd "C:\Users\ksmw9\Desktop\상상과 창조\DB 논문 공모전\master_csv"

// 2. CSV 파일 불러오기
import delimited "panel_data_clean.csv", clear

// 3. 데이터 일부 확인 (첫 5개 관측치)
list in 1/5

// 4. 패널 데이터 구조 설정  
//    - 패널 식별자: md제공용_가구고유번호  
//    - 시간 변수: 조사연도
xtset md제공용_가구고유번호 조사연도

// 4-1. 종속변수의 시차 변수 생성 (lag_원리금연체여부)
gen lag_원리금연체여부 = L.원리금연체여부

// 5. V17(저축성보장성) 변수 변환: 
//    자산_금융자산_저축_적립예치식저축_저축성보장성보험금액에 10000을 곱한 후 자연로그 취함(단위: 만원이기때문)
//    (값이 0 이하인 경우 ln()은 정의되지 않으므로, 필요한 경우 해당 관측치를 처리하세요)
gen ln_v17 = ln(10000 * 자산_금융자산_저축_적립예치식저축_저축성보장성보험금액)

// 6. 소득5분위코드보완 변수를 숫자형으로 변환  
encode 소득5분위코드보완, gen(n_소득5분위코드보완)

xtlogit 원리금연체여부 lag_원리금연체여부 c.ln_v17##i.n_소득5분위코드보완, re


* 패널 프로빗 모형 분석 =========================================== 


// 0. 모든 메모리 삭제 및 출력 멈춤 해제
clear all
set more off

// 1. 작업 폴더 설정 (경로는 필요에 따라 수정)
cd "C:\Users\ksmw9\Desktop\상상과 창조\DB 논문 공모전\master_csv"

// 2. CSV 파일 불러오기
import delimited "panel_data_clean.csv", clear

// 3. 데이터 일부 확인 (첫 5개 관측치)
list in 1/5

// 4. 패널 데이터 구조 설정  
//    - 패널 식별자: md제공용_가구고유번호  
//    - 시간 변수: 조사연도
xtset md제공용_가구고유번호 조사연도

// (필요시) 종속변수의 시차 변수 생성: 
//    만약 lag_원리금연체여부가 아직 생성되지 않았다면 아래 명령 사용 (xtset 이후에 L. 접두사로 생성 가능)
 xtset md제공용_가구고유번호 조사연도
 gen lag_원리금연체여부 = L.원리금연체여부

// 5. V17(저축성보장성) 변수 변환:  
//    자산_금융자산_저축_적립예치식저축_저축성보장성보험금액에 10,000을 곱하고, 0인 경우 문제를 피하기 위해 +1 후 자연로그 취함
gen ln_v17 = ln(10000* 자산_금융자산_저축_적립예치식저축_저축성보장성보험금액) 

// 6. 소득5분위코드보완 변수를 숫자형 범주형 변수로 변환  
encode 소득5분위코드보완, gen(n_소득5분위코드보완)
xtprobit 원리금연체여부 lag_원리금연체여부 c.ln_v17##i.n_소득5분위코드보완, re

* 선형 확률 모형 분석  ===========================================

// 0. 모든 메모리 삭제 및 출력 멈춤 해제
clear all
set more off

// 1. 작업 폴더 설정 (필요에 따라 경로 수정)
cd "C:\Users\ksmw9\Desktop\상상과 창조\DB 논문 공모전\master_csv"

// 2. CSV 파일 불러오기
import delimited "panel_data_clean.csv", clear

// 3. 데이터 일부 확인 (첫 5개 관측치)
list in 1/5

// 4. 패널 데이터 구조 설정  
//    - 패널 식별자: md제공용_가구고유번호  
//    - 시간 변수: 조사연도
xtset md제공용_가구고유번호 조사연도

// 4-1. 종속변수의 시차(lag) 변수 생성 (lag_원리금연체여부)
//     xtset 이후, L. 접두사를 사용하여 생성
gen lag_원리금연체여부 = L.원리금연체여부

// 5. V17(저축성보장성) 변수 변환:  
//    자산_금융자산_저축_적립예치식저축_저축성보장성보험금액에 10,000을 곱하고, 
//    값이 0인 경우 ln(0)가 발생하지 않도록 +1을 한 후 자연로그 취함
gen ln_v17 = ln(10000 * 자산_금융자산_저축_적립예치식저축_저축성보장성보험금액) 

// 6. 소득5분위코드보완 변수를 숫자형 범주형 변수로 변환  
encode 소득5분위코드보완, gen(n_소득5분위코드보완)

regress 원리금연체여부 lag_원리금연체여부 c.ln_v17##i.n_소득5분위코드보완, ///
    vce(cluster md제공용_가구고유번호)


* 동태 패널 프로빗 모형 평균 한계효과(AME) 계산 ==========================================
margins, dydx(*) predict(pr) atmeans


* 동태 패널 로짓모형에서 평균 한계효과 계산 ============================================
gen me_lag = _b[lag_원리금연체여부] * pr_hat * (1 - pr_hat)
summarize me_lag, meanonly
display "AME for lag_원리금연체여부 = " r(mean)


